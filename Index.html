<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Exam Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #0f172a; --accent: #1e293b; --success: #22c55e; --error: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        #timer { position: fixed; top: 20px; left: 20px; background: var(--accent); color: #fff; padding: 10px 15px; border-radius: 8px; font-weight: bold; font-family: monospace; font-size: 1.1rem; z-index: 1000; display: none; }
        .setup-container { max-width: 650px; margin: 40px auto; background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #475569; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        .guideline-container { border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto; background: #f8fafc; }
        .btn-start { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 20px; }
        #main-quiz-area { display: none; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .quiz-card { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        #progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.4s ease; }
        .option { display: block; width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #f1f5f9; border-radius: 10px; text-align: left; cursor: pointer; background: #f8fafc; font-size: 1rem; width: 100%; }
        .correct { background: #dcfce7 !important; border-color: var(--success) !important; color: #14532d; font-weight: bold; }
        .wrong { background: #fee2e2 !important; border-color: var(--error) !important; color: #7f1d1d; }
        .log-section { max-width: 1200px; margin: 40px auto; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .log-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .log-table th, .log-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: left; }
    </style>
</head>
<body>

<div id="timer">Time Remaining: 60:00</div>

<div id="setup-screen" class="setup-container">
    <h2>Subject Exam Portal</h2>
    <div class="form-group">
        <label>Subject Name:</label>
        <input type="text" id="subjectName" placeholder="e.g. Managerial Communications">
    </div>
    <div class="form-group">
        <label>Upload Excel Bank:</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
    </div>
    <div id="filter-options" style="display:none;">
        <div class="form-group">
            <label>Select Guideline(s):</label>
            <div id="guideline-list" class="guideline-container"></div>
            <button onclick="toggleAll(true)" style="margin-top:5px;">Select All</button>
            <button onclick="toggleAll(false)" style="margin-top:5px;">Deselect All</button>
        </div>
        <div class="form-group">
            <label>Number of Questions:</label>
            <input type="number" id="questionCount" value="50">
        </div>
        <button class="btn-start" onclick="initializeQuiz()">Start Practice Session</button>
    </div>
</div>

<div id="main-quiz-area">
    <div style="text-align:center; margin-bottom:20px;">
        <h1 id="displaySubject"></h1>
        <p id="displayFilter"></p>
    </div>
    <div class="container">
        <div class="quiz-card">
            <div class="progress-bar"><div id="progress-fill"></div></div>
            <div id="quiz-box">
                <div class="question" id="question-text" style="font-size:1.3rem; font-weight:600; margin-bottom:20px;"></div>
                <div id="options-container"></div>
                <button id="next-btn" onclick="nextQuestion()" style="width:100%; margin-top:20px; background:var(--accent); color:white; border:none; padding:16px; border-radius:10px; display:none; cursor:pointer;">Next Question â†’</button>
            </div>
            <div id="result-box" style="display:none; text-align:center;">
                <h2>Practice Session Complete</h2>
                <p id="score-text" style="font-size:1.8rem; font-weight:bold;"></p>
                <button onclick="softReset()" class="btn-start" style="width:auto; padding:10px 40px;">New Attempt / Change Guidelines</button>
            </div>
        </div>
        <div class="explanation-card" id="explanation-box" style="background:#fff; border-left:6px solid var(--primary); padding:1.5rem; border-radius:12px; display:none;">
            <h3 style="color:var(--primary); margin-top:0;">Explanation</h3>
            <p id="explanation-text"></p>
        </div>
    </div>
</div>

<div class="log-section">
    <h3>Attempt History Log</h3>
    <table class="log-table">
        <thead>
            <tr><th>Attempt</th><th>Subject</th><th>Score</th><th>Time Used</th><th>Date</th></tr>
        </thead>
        <tbody id="log-body"></tbody>
    </table>
</div>

<script>
    let masterBank = [];
    let currentQuiz = [];
    let currentIdx = 0;
    let score = 0;
    let timeLeft = 3600;
    let timerInterval;
    let refColumn = "";
    let attemptCount = 0;

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            masterBank = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            if (masterBank.length > 0) {
                const keys = Object.keys(masterBank[0]);
                refColumn = keys.find(k => k.toLowerCase().includes('ref') || k.toLowerCase().includes('guide')) || keys[0];
                generateCheckboxes();
                document.getElementById('filter-options').style.display = 'block';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function generateCheckboxes() {
        const listArea = document.getElementById('guideline-list');
        listArea.innerHTML = "";
        const guidelines = [...new Set(masterBank.map(item => String(item[refColumn] || "General")))].sort();
        guidelines.forEach(g => {
            const div = document.createElement('div');
            div.innerHTML = `<label style="display:flex; align-items:center; padding:4px;"><input type="checkbox" name="guideline" value="${g}" checked> <span style="margin-left:8px;">${g}</span></label>`;
            listArea.appendChild(div);
        });
    }

    function toggleAll(state) {
        document.querySelectorAll('input[name="guideline"]').forEach(cb => cb.checked = state);
    }

    function initializeQuiz() {
        const selected = Array.from(document.querySelectorAll('input[name="guideline"]:checked')).map(cb => cb.value);
        const limit = parseInt(document.getElementById('questionCount').value) || 50;
        if (selected.length === 0) return alert("Select at least one guideline!");

        const filtered = masterBank.filter(item => selected.includes(String(item[refColumn] || "General")));
        currentQuiz = filtered.sort(() => Math.random() - 0.5).slice(0, limit);
        
        if (currentQuiz.length === 0) return alert("No questions found!");

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-quiz-area').style.display = 'block';
        document.getElementById('timer').style.display = 'block';
        document.getElementById('displaySubject').innerText = document.getElementById('subjectName').value || "Exam Practice";
        
        score = 0;
        currentIdx = 0;
        timeLeft = 3600;
        loadQuestion();
        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            let mins = Math.floor(timeLeft / 60);
            let secs = timeLeft % 60;
            document.getElementById("timer").innerText = `Time Remaining: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
            if (timeLeft <= 0) finishQuiz();
        }, 1000);
    }

    function loadQuestion() {
        const raw = currentQuiz[currentIdx];
        const correctVal = (raw['Correct Answer'] || "").toString().trim().toUpperCase();
        const optionsMap = { 'A': raw['Option A'], 'B': raw['Option B'], 'C': raw['Option C'], 'D': raw['Option D'] };
        const correctText = optionsMap[correctVal] || correctVal;

        document.getElementById("progress-fill").style.width = `${(currentIdx / currentQuiz.length) * 100}%`;
        document.getElementById("question-text").innerText = `${currentIdx + 1}. ${raw.Question}`;
        document.getElementById("explanation-box").style.display = "none";
        
        const container = document.getElementById("options-container");
        container.innerHTML = "";
        document.getElementById("next-btn").style.display = "none";

        ['Option A', 'Option B', 'Option C', 'Option D'].forEach(key => {
            if (!raw[key]) return;
            const btn = document.createElement("button");
            btn.className = "option";
            btn.innerText = raw[key];
            btn.onclick = () => {
                document.querySelectorAll(".option").forEach(b => b.disabled = true);
                if (btn.innerText.trim() === correctText.trim()) {
                    score++;
                    btn.classList.add("correct");
                } else {
                    btn.classList.add("wrong");
                    document.querySelectorAll(".option").forEach(b => {
                        if(b.innerText.trim() === correctText.trim()) b.classList.add("correct");
                    });
                }
                document.getElementById("explanation-text").innerText = raw.Explanation || "Review communication principles.";
                document.getElementById("explanation-box").style.display = "block";
                document.getElementById("next-btn").style.display = "block";
            };
            container.appendChild(btn);
        });
    }

    function nextQuestion() {
        currentIdx++;
        if (currentIdx < currentQuiz.length) loadQuestion(); else finishQuiz();
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        attemptCount++;
        document.getElementById("progress-fill").style.width = "100%";
        document.getElementById("quiz-box").style.display = "none";
        document.getElementById("result-box").style.display = "block";
        document.getElementById("score-text").innerText = `Score: ${score} / ${currentQuiz.length}`;

        const logBody = document.getElementById("log-body");
        const row = logBody.insertRow(0);
        const timeSpent = 3600 - timeLeft;
        row.innerHTML = `<td>#${attemptCount}</td><td>${document.getElementById('subjectName').value}</td><td>${score}/${currentQuiz.length}</td><td>${Math.floor(timeSpent/60)}m ${timeSpent%60}s</td><td>${new Date().toLocaleDateString()}</td>`;
    }

    function softReset() {
        document.getElementById('setup-screen').style.display = 'block';
        document.getElementById('main-quiz-area').style.display = 'none';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('result-box').style.display = 'none';
        document.getElementById('quiz-box').style.display = 'block';
    }
</script>
</body>
</html>